<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üé¥ EchoMind - Card Tricks</title>
  <script src="../scripts/mic_handler.js"></script>
  
<style>
  body {
    background: #0b0b0b;
    color: white;
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    text-align: center;
  }
  h1 {
    color: #ffe066;
    text-shadow: 0 0 10px gold;
  }
  button {
    font-size: 1.2em;
    padding: 10px 20px;
    margin: 15px;
    background: #1a1a3d;
    color: white;
    border: 2px solid gold;
    border-radius: 10px;
  }
  button:hover {
    background: #333;
  }
  .controls {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #reveal {
    margin-top: 30px;
    font-size: 2em;
    color: gold;
    text-shadow: 0 0 10px gold;
    max-width: 90vw;
    word-wrap: break-word;
  }
  .back-button {
    position: fixed;
    top: 20px;
    left: 20px;
    color: white;
    text-decoration: none;
    font-size: 1.5em;
    z-index: 10;
    background: rgba(0, 0, 0, 0.5);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid gold;
    transition: all 0.3s ease;
  }
  .back-button:hover {
    transform: scale(1.1);
    box-shadow: 0 0 15px #ffe066;
  }
</style>
</head>
<body>
<a href="../index.html" class="back-button">‚Üê</a>

<h1>üé¥ Card Tricks</h1>

<div class="controls">
  <button onclick="toggleListening()" class="control-button">üéôÔ∏è Toggle Mic</button>
  <label style="margin-top:10px;">
    <input type="checkbox" id="keepListening" checked onchange="updateListening()" />
    ‚ôªÔ∏è Keep Listening
  </label>
</div>
<div id="reveal">Waiting for microphone permission...</div>

<script>
const cardMap = {
  "ace of spades": "ace_of_spades.png",
  "ace of hearts": "ace_of_hearts.png",
  "ace of diamonds": "ace_of_diamonds.png",
  "ace of clubs": "ace_of_clubs.png",
  "king of spades": "king_of_spades.png",
  "king of hearts": "king_of_hearts.png",
  "king of diamonds": "king_of_diamonds.png",
  "king of clubs": "king_of_clubs.png",
  "queen of spades": "queen_of_spades.png",
  "queen of hearts": "queen_of_hearts.png",
  "queen of diamonds": "queen_of_diamonds.png",
  "queen of clubs": "queen_of_clubs.png",
  "jack of spades": "jack_of_spades.png",
  "jack of hearts": "jack_of_hearts.png",
  "jack of diamonds": "jack_of_diamonds.png",
  "jack of clubs": "jack_of_clubs.png",
  "ten of spades": "10_of_spades.png",
  "ten of hearts": "10_of_hearts.png",
  "ten of diamonds": "10_of_diamonds.png",
  "ten of clubs": "10_of_clubs.png",
  "nine of spades": "9_of_spades.png",
  "nine of hearts": "9_of_hearts.png",
  "nine of diamonds": "9_of_diamonds.png",
  "nine of clubs": "9_of_clubs.png",
  "eight of spades": "8_of_spades.png",
  "eight of hearts": "8_of_hearts.png",
  "eight of diamonds": "8_of_diamonds.png",
  "eight of clubs": "8_of_clubs.png",
  "seven of spades": "7_of_spades.png",
  "seven of hearts": "7_of_hearts.png",
  "seven of diamonds": "7_of_diamonds.png",
  "seven of clubs": "7_of_clubs.png",
  "six of spades": "6_of_spades.png",
  "six of hearts": "6_of_hearts.png",
  "six of diamonds": "6_of_diamonds.png",
  "six of clubs": "6_of_clubs.png",
  "five of spades": "5_of_spades.png",
  "five of hearts": "5_of_hearts.png",
  "five of diamonds": "5_of_diamonds.png",
  "five of clubs": "5_of_clubs.png",
  "four of spades": "4_of_spades.png",
  "four of hearts": "4_of_hearts.png",
  "four of diamonds": "4_of_diamonds.png",
  "four of clubs": "4_of_clubs.png",
  "three of spades": "3_of_spades.png",
  "three of hearts": "3_of_hearts.png",
  "three of diamonds": "3_of_diamonds.png",
  "three of clubs": "3_of_clubs.png",
  "two of spades": "2_of_spades.png",
  "two of hearts": "2_of_hearts.png",
  "two of diamonds": "2_of_diamonds.png",
  "two of clubs": "2_of_clubs.png",
  "red joker": "red_joker.png",
  "black joker": "black_joker.png"
};

function matchCard(text) {
  const lower = text.toLowerCase();
  for (const [phrase, card] of Object.entries(cardMap)) {
    if (lower.includes(phrase)) return card;
  }
  return null;
}

function showCard(cardFile) {
  const output = document.getElementById("reveal");
  output.innerHTML = `<img src="../images/${cardFile}" style="max-width: 300px; max-height: 400px;" />`;
  new Audio("https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-reward-952.mp3").play();
}

function toggleListening() {
  if (window.micHandler.listening) {
    window.micHandler.stop();
  } else {
    window.micHandler.start(document.getElementById("keepListening").checked);
  }
}

function updateListening() {
  const keepListening = document.getElementById("keepListening").checked;
  if (window.micHandler.listening) {
    window.micHandler.start(keepListening);
  }
}

// Set up callbacks for the microphone handler
window.micHandler.setCallbacks({
  onStart: () => {
    document.getElementById("reveal").innerText = "üéôÔ∏è Listening...";
  },
  onEnd: () => {
    if (!window.micHandler.keepListening) {
      document.getElementById("reveal").innerText = "(Mic stopped)";
    }
  },
  onResult: (transcript) => {
    console.log('Heard:', transcript);
    const cardFile = matchCard(transcript);
    if (cardFile) {
      showCard(cardFile);
    } else {
      document.getElementById("reveal").innerText = "‚ùì I didn't recognize a valid card.";
    }
  },
  onError: (event) => {
    let message = "‚ùå ";
    switch (event.error) {
      case 'not-allowed':
      case 'permission-denied':
        message += "Microphone access denied. Please allow microphone access and try again.";
        break;
      case 'network':
        message += "Network error. Please check your connection.";
        break;
      case 'no-speech':
        message += "No speech detected. Please try again.";
        break;
      default:
        message += `Error: ${event.error}`;
    }
    document.getElementById("reveal").innerText = message;
  }
});

// Start listening if permission was already granted
if (window.micHandler.hasPermission && document.getElementById("keepListening").checked) {
  window.micHandler.start(true);
}

// Triple tap detection for reset
let tapCount = 0;
let lastTap = 0;

document.addEventListener('click', (e) => {
  const now = Date.now();
  if (now - lastTap < 500) {
    tapCount++;
    if (tapCount === 3) {
      document.getElementById("reveal").innerText = "Waiting for voice input...";
      tapCount = 0;
    }
  } else {
    tapCount = 1;
  }
  lastTap = now;
});
</script>

</body>
</html> 